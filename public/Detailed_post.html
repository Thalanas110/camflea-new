<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Details</title>
    <link rel="stylesheet" href="tablet-responsive.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="modal-system.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            color: #2c3e50;
            line-height: 1.6;
            min-height: 100vh;
        }

        .details-layout {
            display: flex;
            gap: 30px;
            max-width: 1400px;
            margin: 40px auto 0 auto;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            border: 2px solid transparent;
            padding: 40px;
            align-items: flex-start;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .details-layout::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #049516, #37d84a);
        }
        
        /* Responsive adjustments for tablets and smaller screens */
        @media (max-width: 1024px) {
            .details-layout {
                flex-direction: column;
                gap: 24px;
                margin: 20px;
                padding: 24px;
                max-width: none;
            }
            
            .details-left {
                width: 100%;
                min-width: auto;
            }
            
            .details-right {
                width: 100%;
                min-width: auto;
                padding-right: 0;
            }
        }
        
        @media (max-width: 768px) {
            .details-layout {
                margin: 10px;
                padding: 16px;
                border-radius: 8px;
            }
            
            .image-gallery img,
            .carousel-image {
                width: 100%;
                max-width: 280px;
                height: auto;
                aspect-ratio: 4/3;
            }
            
            .carousel-container {
                width: 100%;
                max-width: 280px;
                height: auto;
                aspect-ratio: 4/3;
            }
        }
        .details-left {
            flex: 1 1 420px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 320px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 16px;
            padding: 30px 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .details-left::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3498db, #5dade2);
        }

        .image-gallery {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            margin-bottom: 25px;
            padding: 10px 0;
        }
        
        .image-gallery img {
            width: 320px;
            height: 240px;
            object-fit: cover;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid transparent;
        }
        
        .image-gallery img:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            border-color: rgba(52, 152, 219, 0.3);
        }
        
        .details-right {
            flex: 2 1 600px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 400px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 16px;
            padding: 35px 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .details-right::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #e74c3c, #ec7063);
        }
        
        /* Responsive adjustments for details-right */
        @media (max-width: 1024px) {
            .details-right {
                min-width: auto;
                width: 100%;
                padding-right: 0;
            }
        }
        .item-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            letter-spacing: 0.3px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
            position: relative;
            padding-bottom: 12px;
        }

        .item-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #049516, #37d84a);
            border-radius: 2px;
        }
        
        /* Responsive adjustments for item-title */
        @media (max-width: 768px) {
            .item-title {
                font-size: 1.2rem;
                line-height: 1.25;
            }
        }
        
        @media (max-width: 480px) {
            .item-title {
                font-size: 1.1rem;
                margin-bottom: 8px;
            }
        }
        .user-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid rgba(4, 149, 22, 0.1);
        }
        
        .user-row img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border: 3px solid #fff;
        }
        
        .user-row .poster-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2c3e50;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Responsive adjustments for user-row */
        @media (max-width: 480px) {
            .user-row {
                gap: 8px;
            }
            
            .user-row img {
                width: 36px;
                height: 36px;
            }
            
            .user-row .poster-name {
                font-size: 0.9rem;
            }
        }
        .price-box {
            background: linear-gradient(135deg, #049516, #37d84a);
            border-radius: 16px;
            padding: 25px 30px;
            font-size: 1.6rem;
            color: #ffffff;
            margin: 20px 0 25px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 400px;
            font-weight: 700;
            flex-wrap: wrap;
            gap: 10px;
            box-shadow: 0 6px 20px rgba(4, 149, 22, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .price-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            pointer-events: none;
        }
        
        .price-box .posted-time {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            white-space: nowrap;
            background: rgba(255, 255, 255, 0.15);
            padding: 5px 12px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        /* Responsive adjustments for price-box */
        @media (max-width: 768px) {
            .price-box {
                flex-direction: column;
                align-items: flex-start;
                max-width: none;
                font-size: 1.25rem;
                gap: 4px;
            }
            
            .price-box .posted-time {
                font-size: 0.85rem;
            }
        }
        .meta-table {
            display: grid;
            grid-template-columns: 160px 1fr;
            row-gap: 15px;
            column-gap: 25px;
            margin-bottom: 25px;
            width: 100%;
            max-width: 550px;
            font-size: 1rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid rgba(4, 149, 22, 0.1);
        }
        
        .meta-table span:first-child {
            color: #7f8c8d;
            font-weight: 600;
            letter-spacing: 0.2px;
            font-size: 0.95rem;
            text-transform: uppercase;
        }
        
        .meta-table span:nth-child(even) {
            color: #2c3e50;
            font-weight: 500;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-size: 1.05rem;
        }
        
        /* Responsive adjustments for meta-table */
        @media (max-width: 768px) {
            .meta-table {
                grid-template-columns: 120px 1fr;
                column-gap: 12px;
                font-size: 0.9rem;
                max-width: none;
            }
        }
        
        @media (max-width: 480px) {
            .meta-table {
                grid-template-columns: 1fr;
                row-gap: 4px;
            }
            
            .meta-table span:first-child {
                font-weight: 600;
                color: #666;
                margin-bottom: 2px;
            }
            
            .meta-table span:nth-child(even) {
                margin-bottom: 12px;
            }
        }
        
        .description {
            margin-bottom: 25px;
            color: #2c3e50;
            width: 100%;
            max-width: 550px;
            font-size: 1.1rem;
            line-height: 1.7;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #049516;
            position: relative;
        }

        .description::before {
            content: 'üìù';
            position: absolute;
            top: -10px;
            left: 20px;
            background: #fff;
            padding: 5px 10px;
            font-size: 1.2rem;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .action-buttons {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            width: 100%;
            max-width: 550px;
            flex-wrap: wrap;
        }
        
        .action-buttons button {
            flex: 1;
            background: linear-gradient(135deg, #049516, #37d84a);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(4, 149, 22, 0.25);
            white-space: nowrap;
            min-width: 140px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-buttons button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .action-buttons button:hover::before {
            left: 100%;
        }
        
        .action-buttons button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(4, 149, 22, 0.35);
            background: linear-gradient(135deg, #037a12, #2ecc71);
        }
        
        .action-buttons button:disabled {
            background: linear-gradient(135deg, #95a5a6, #bdc3c7);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .action-buttons button:disabled::before {
            display: none;
        }
        
        /* Responsive adjustments for action-buttons */
        @media (max-width: 768px) {
            .action-buttons {
                gap: 12px;
                max-width: none;
            }
            
            .action-buttons button {
                font-size: 0.95rem;
                padding: 10px 8px;
            }
        }
        
        @media (max-width: 480px) {
            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .action-buttons button {
                width: 100%;
                padding: 12px;
                min-width: auto;
            }
        }
        .back-button {
            position: fixed;
            left: 40px;
            bottom: 40px;
            z-index: 100;
            width: 140px;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 15px 0;
            border-radius: 50px;
            background: linear-gradient(135deg, #049516, #37d84a);
            color: #fff;
            border: none;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(4, 149, 22, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .back-button::before {
            content: '‚Üê ';
            font-size: 1.3rem;
        }
        
        .back-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(4, 149, 22, 0.4);
            background: linear-gradient(135deg, #037a12, #2ecc71);
        }
        .carousel-container {
            position: relative;
            width: 360px;
            height: 260px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border: 3px solid rgba(52, 152, 219, 0.2);
        }
        
        .carousel-image {
            width: 360px;
            height: 260px;
            object-fit: cover;
            cursor: zoom-in;
            transition: transform 0.3s ease;
        }

        .carousel-image:hover {
            transform: scale(1.05);
        }
        
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #049516, #37d84a);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.6rem;
            cursor: pointer;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(4, 149, 22, 0.3);
        }
        
        .carousel-arrow:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(4, 149, 22, 0.4);
            background: linear-gradient(135deg, #037a12, #2ecc71);
        }
        
        .carousel-arrow.left {
            left: 15px;
        }
        
        .carousel-arrow.right {
            right: 15px;
        }
        .modal-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #049516, #37d84a);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            font-size: 2.2rem;
            cursor: pointer;
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(4, 149, 22, 0.3);
        }
        
        .modal-arrow:hover {
            transform: translateY(-50%) scale(1.1);
            background: linear-gradient(135deg, #037a12, #2ecc71);
            box-shadow: 0 8px 25px rgba(4, 149, 22, 0.4);
        }
        
        .modal-arrow.left {
            left: 100px;
        }
        
        .modal-arrow.right {
            right: 100px;
        }
        .zoomed-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .zoomed-modal {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 95vw;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .zoomed-modal img {
            max-width: 85vw;
            max-height: 75vh;
            border-radius: 12px;
            background: #fff;
            cursor: grab;
            transition: transform 0.3s;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .zoomed-modal .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2.2rem;
            color: #fff;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .zoomed-modal .close-btn:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #c0392b, #a93226);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }
        /* --- Begin Carousel & Modal Styles --- */
        .item-image-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 30px;
        }
        
        .main-image {
            display: block;
            margin: 0 auto 20px auto;
            width: 360px;
            height: 270px;
            object-fit: contain;
            border-radius: 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border: 3px solid rgba(52, 152, 219, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: zoom-in;
            padding: 10px;
        }
        
        .main-image:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 35px rgba(0,0,0,0.25);
            border-color: rgba(52, 152, 219, 0.4);
        }
        
        .carousel {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 0;
            justify-content: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .carousel-btn {
            background: linear-gradient(135deg, #049516, #37d84a);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(4, 149, 22, 0.3);
        }

        .carousel-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(4, 149, 22, 0.4);
            background: linear-gradient(135deg, #037a12, #2ecc71);
        }
        
        .carousel-thumbs {
            display: flex;
            gap: 12px;
        }
        
        .carousel-thumbs img {
            width: 55px;
            height: 42px;
            object-fit: cover;
            border-radius: 8px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .carousel-thumbs img:hover {
            transform: translateY(-2px);
            border-color: rgba(52, 152, 219, 0.3);
        }
        
        .carousel-thumbs img.selected {
            border: 3px solid #049516;
            box-shadow: 0 6px 18px rgba(4, 149, 22, 0.25);
            transform: translateY(-2px) scale(1.05);
        }
        /* Modal for enlarged image */
        #image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        #close-image-modal {
            position: absolute;
            top: 32px;
            right: 48px;
            color: #fff;
            font-size: 2.2rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
        }
        #modal-image {
            max-width: 80vw;
            max-height: 80vh;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            background: #fff;
            display: block;
        }
        /* --- End Carousel & Modal Styles --- */
    </style>
</head>
<body>
    <div class="details-layout" id="item-details"></div>
    <a href="index.html" class="back-button" id="backButton">Back</a>
    <div id="error-message" style="
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10000;
  background: linear-gradient(135deg, #2ecc71, #27ae60);
  color: white;
  padding: 20px 35px;
  border-radius: 16px;
  font-weight: 600;
  display: none;
  box-shadow: 0 8px 30px rgba(46, 204, 113, 0.3);
  max-width: 90%;
  text-align: center;
  font-size: 1.1rem;
  border: 2px solid rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
"></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabaseUrl = 'https://wuhgqjeijmxsgvnykttj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1aGdxamVpam14c2d2bnlrdHRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI4MjkzMDQsImV4cCI6MjA1ODQwNTMwNH0._lZy7CE2A8HM1hatjGYrMR8QAUi8nk4L_EuV7Fojhwg';

        const supabaseClient = createClient(supabaseUrl, supabaseKey);

    // Hide back button if embedded in iframe modal
    if (new URLSearchParams(window.location.search).get('embedded') === '1') {
        const backButton = document.getElementById('backButton');
        if (backButton) {
            backButton.style.display = 'none';
        }
    }

    async function fetchItemDetails() {
    const urlParams = new URLSearchParams(window.location.search);
    const itemId = urlParams.get('item_id');

    if (!itemId) {
        alert('No item selected.');
        window.location.href = 'index.html';
        return;
    }

    // Retrieve the logged-in user's stud_id from localStorage
    const loggedInStudId = localStorage.getItem('stud_id');
    console.log('Logged-in stud_id:', loggedInStudId); // Debugging: Log the logged-in user's stud_id

    const { data: items, error } = await supabaseClient
        .from('item')
        .select(`
            item_name,
            item_description,
            item_price,
            item_price_type,
            item_price_min,
            item_price_max,
            item_condition,
            item_type,
            item_status,
            meeting_place,
            created_at,
            photos,
            student:stud_id (
                stud_id,
                stud_fname,
                stud_lname,
                stud_school,
                stud_picture,
                user_id
            )
        `)
        .eq('item_id', itemId);

    if (error) {
        console.error('Error fetching item details:', error);
        alert('Failed to load item details.');
        return;
    }

    if (!items || items.length === 0) {
        alert('Item not found.');
        window.location.href = 'index.html';
        return;
    }

    const item = items[0];

    // Check if item is already in cart for this user
    let isInCart = false;
    let isInCurrentlyBuying = false;
    let buyerIdForItem = null;

        if (loggedInStudId) {
            // Fetch buyer_id for this item from transactions with status 'requested' or 'reserved'
            const { data: buyerData, error: buyerError } = await supabaseClient
                .from('transactions')
                .select('buyer_id')
                .eq('item_uuid', itemId)
                .eq('status', 'requested')
                .limit(1);

            if (buyerError) {
                console.error('Error fetching buyer_id for item:', buyerError);
            } else if (buyerData && buyerData.length > 0) {
                buyerIdForItem = buyerData[0].buyer_id;
            }

        // Check cart items
        const { data: cartItems, error: cartError } = await supabaseClient
            .from('transactions')
            .select('item_uuid')
            .eq('buyer_id', loggedInStudId)
            .eq('status', 'cart');

        if (cartError) {
            console.error('Error fetching cart items:', cartError);
        } else if (cartItems) {
            isInCart = cartItems.some(cartItem => String(cartItem.item_uuid) === String(itemId));
        }

        // Check currently buying items (status 'requested')
        const { data: currentlyBuyingItems, error: currentlyBuyingError } = await supabaseClient
            .from('transactions')
            .select('item_uuid')
            .eq('buyer_id', loggedInStudId)
            .eq('status', 'requested');

        if (currentlyBuyingError) {
            console.error('Error fetching currently buying items:', currentlyBuyingError);
        } else if (currentlyBuyingItems) {
            isInCurrentlyBuying = currentlyBuyingItems.some(item => String(item.item_uuid) === String(itemId));
        }
    }

    const timePosted = timeAgo(item.created_at);
    const container = document.getElementById('item-details');

    console.log('loggedInStudId:', loggedInStudId);
    console.log('item.buyer_id:', item.buyer_id);

    const photosHtml = item.photos
        .map(photo => `
            <img src="${photo}" alt="${item.item_name}" onclick="zoomImage(this)">
        `)
        .join('');

    // Determine price display based on price type
    let priceDisplay = '';
    if (item.item_price_type === 'single') {
        priceDisplay = `‚Ç±${formatPrice(item.item_price)}`;
    } else if (item.item_price_type === 'range') {
        priceDisplay = `‚Ç±${formatPrice(item.item_price_min)} - ‚Ç±${formatPrice(item.item_price_max)}`;
    } else if (item.item_price_type === 'hidden') {
        priceDisplay = 'Price hidden';
    } else {
        priceDisplay = 'Price not available';
    }

    // Check if the logged-in user is the owner of the item
    const isOwner = loggedInStudId && item.student && (String(loggedInStudId) === String(item.student.stud_id));

    container.innerHTML = `
        <div class="details-left">
            <div class="carousel-container">
                <button class="carousel-arrow left" style="display: ${item.photos && item.photos.length > 1 ? 'flex' : 'none'}">&#8592;</button>
                <img class="carousel-image" src="${item.photos && item.photos[0] ? item.photos[0] : 'Homepage_images/circle-user.png'}" alt="${item.item_name}">
                <button class="carousel-arrow right" style="display: ${item.photos && item.photos.length > 1 ? 'flex' : 'none'}">&#8594;</button>
            </div>
            <div class="carousel-thumbs">
                ${
                  item.photos && item.photos.length > 1
                    ? item.photos.map((photo, index) => `
                        <img src="${photo}" alt="${item.item_name} thumbnail ${index + 1}" class="${index === 0 ? 'selected' : ''}" data-index="${index}">
                      `).join('')
                    : ''
                }
            </div>
                        </div>
<div id="error-message" style="
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 1000;
                background-color: #e74c3c;
                color: white;
                padding: 16px 32px;
                border-radius: 8px;
                font-weight: bold;
                display: none;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                max-width: 90%;
                text-align: center;
                font-size: 1rem;
                "></div>



        <div class="details-right">
            <div class="item-title">${item.item_name}</div>
            <div class="user-row">
                <img src="${item.student.stud_picture || 'Homepage_images/circle-user.png'}" 
                    alt="Profile Picture" 
                    class="poster-profile" 
                    style="cursor: pointer;">
                <span class="poster-name" style="cursor: pointer;">
                    ${item.student.stud_fname} ${item.student.stud_lname} (${item.student.stud_school})
                </span>
                <!-- Add rating here if needed -->
            </div>
            <div class="price-box">
                <span>${priceDisplay}</span>
                <span class="posted-time">Posted: ${timePosted}</span>
            </div>
            <div class="meta-table">
                <span>Meeting Place</span><span>${item.meeting_place || 'N/A'}</span>
                <span>School Institution</span><span>${item.student.stud_school || 'N/A'}</span>
                <span>Item Type</span><span>${item.item_type || 'N/A'}</span>
                <span>Condition</span><span>${item.item_condition || 'N/A'}</span>
                <span>Description</span><span>${item.item_description || ''}</span>
            </div>
            <div class="action-buttons">
                ${
                  item.item_status === 'sold'
                  ? ''
                  : !isOwner && item.item_status === 'reserved' && loggedInStudId !== String(item.student.stud_id) && loggedInStudId !== String(buyerIdForItem)
                    ? `
            <button id="notify-me-button">Notify Me</button>
            <span id="notify-me-note" style="font-size: 0.9rem; color: #555; margin-left: 10px;">Item currently in transaction, you will be notified if it is cancelled</span>
          `
                    : !isOwner
                    ? `<button id="buy-button" ${isInCurrentlyBuying ? 'disabled' : ''}>${isInCurrentlyBuying ? 'In Listing' : 'Buy'}</button>${isInCurrentlyBuying ? '' : `<button id="add-to-cart-button" ${isInCart ? 'disabled' : ''}>${isInCart ? 'Added to Cart' : 'Add to Cart'}</button>`}`
                    : ''
                }
            </div>
        </div>
    `;

    console.log('Poster stud_id:', item.student.stud_id);

    // Add click event listeners after the HTML is added to the DOM
    document.querySelector('.poster-profile').onclick = () => {
    if (item.student && item.student.stud_id) {
        redirectToProfile(item.student.stud_id);
    } else {
        console.error('stud_id is undefined for this post.');
    }
};

document.querySelector('.poster-name').onclick = () => {
    if (item.student && item.student.stud_id) {
        redirectToProfile(item.student.stud_id);
    } else {
        console.error('stud_id is undefined for this post.');
    }
};

// Carousel functionality for multiple photos
const carouselImage = document.querySelector('.carousel-image');
const leftArrow = document.querySelector('.carousel-arrow.left');
const rightArrow = document.querySelector('.carousel-arrow.right');
const thumbnails = document.querySelectorAll('.carousel-thumbs img');

let currentPhotoIndex = 0;

function updateCarousel(index) {
    if (!item.photos || item.photos.length === 0) return;
    currentPhotoIndex = index;
    carouselImage.src = item.photos[currentPhotoIndex];
    carouselImage.alt = `${item.item_name} image ${currentPhotoIndex + 1}`;
    thumbnails.forEach((thumb, i) => {
        if (i === currentPhotoIndex) {
            thumb.classList.add('selected');
        } else {
            thumb.classList.remove('selected');
        }
    });
}

if (leftArrow && rightArrow && thumbnails.length > 0) {
    leftArrow.addEventListener('click', () => {
        currentPhotoIndex = (currentPhotoIndex - 1 + item.photos.length) % item.photos.length;
        updateCarousel(currentPhotoIndex);
    });

    rightArrow.addEventListener('click', () => {
        currentPhotoIndex = (currentPhotoIndex + 1) % item.photos.length;
        updateCarousel(currentPhotoIndex);
    });

    thumbnails.forEach((thumb, index) => {
        thumb.addEventListener('click', () => {
            updateCarousel(index);
        });
    });
}

// Add zoom on main carousel image click with drag detection
if (carouselImage) {
    let mouseDownX = 0;
    let mouseDownY = 0;
    let mouseUpX = 0;
    let mouseUpY = 0;
    const dragThreshold = 5; // pixels

    carouselImage.addEventListener('mousedown', (e) => {
        mouseDownX = e.clientX;
        mouseDownY = e.clientY;
    });

    carouselImage.addEventListener('mouseup', (e) => {
        mouseUpX = e.clientX;
        mouseUpY = e.clientY;
        const deltaX = Math.abs(mouseUpX - mouseDownX);
        const deltaY = Math.abs(mouseUpY - mouseDownY);
        if (deltaX < dragThreshold && deltaY < dragThreshold) {
            zoomImage(carouselImage);
        }
    });
}

const buyButton = document.getElementById('buy-button');
if (buyButton) {
    let buyButtonClicked = false;
    buyButton.addEventListener('click', () => {
        if (buyButtonClicked) return;
        buyButtonClicked = true;

        // Create popup overlay
        const popupOverlay = document.createElement('div');
        popupOverlay.id = 'popup-overlay';
        popupOverlay.style.position = 'fixed';
        popupOverlay.style.top = '0';
        popupOverlay.style.left = '0';
        popupOverlay.style.width = '100%';
        popupOverlay.style.height = '100%';
        popupOverlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
        popupOverlay.style.display = 'flex';
        popupOverlay.style.justifyContent = 'center';
        popupOverlay.style.alignItems = 'center';
        popupOverlay.style.zIndex = '1000';

        // Create popup box
        const popupBox = document.createElement('div');
        popupBox.style.backgroundColor = 'white';
        popupBox.style.padding = '20px';
        popupBox.style.borderRadius = '8px';
        popupBox.style.textAlign = 'center';
        popupBox.style.maxWidth = '300px';
        popupBox.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';

        // Popup message
        const message = document.createElement('p');
        message.textContent = 'Do you really want to buy this item?';
        message.style.marginBottom = '20px';

        // Yes button
        const yesButton = document.createElement('button');
        yesButton.textContent = 'Yes';
        yesButton.style.marginRight = '10px';
        yesButton.style.padding = '10px 20px';
        yesButton.style.backgroundColor = '#069210';
        yesButton.style.color = 'white';
        yesButton.style.border = 'none';
        yesButton.style.borderRadius = '5px';
        yesButton.style.cursor = 'pointer';

        // No button
        const noButton = document.createElement('button');
        noButton.textContent = 'No';
        noButton.style.padding = '10px 20px';
        noButton.style.backgroundColor = '#ccc';
        noButton.style.border = 'none';
        noButton.style.borderRadius = '5px';
        noButton.style.cursor = 'pointer';

        // Append buttons and message to popup box
        popupBox.appendChild(message);
        popupBox.appendChild(yesButton);
        popupBox.appendChild(noButton);

        // Append popup box to overlay
        popupOverlay.appendChild(popupBox);

        // Append overlay to body
        document.body.appendChild(popupOverlay);

        // No button closes popup
        noButton.addEventListener('click', () => {
            document.body.removeChild(popupOverlay);
            buyButtonClicked = false;
        });

        // Yes button redirects to message_page.html with pre-filled message
                yesButton.addEventListener('click', async () => {
                    if (yesButton.disabled) return;
                    yesButton.disabled = true;

                    // Check if user is logged in and has a valid session
                    const session = await supabaseClient.auth.getSession();
                    const accessToken = session.data.session?.access_token;
                    if (!accessToken) {
                        alert('You must be logged in to buy an item.');
                        yesButton.disabled = false;
                        buyButtonClicked = false;
                        return;
                    }

                    const buyerId = localStorage.getItem('stud_id');
                    const sellerId = item.student.stud_id;

                    // Check if item is already in cart for this user
                    try {
                        const { data: cartItems, error: cartError } = await supabaseClient
                            .from('transactions')
                            .select('transac_id')
                            .eq('buyer_id', buyerId)
                            .eq('item_uuid', itemId)
                            .eq('status', 'cart')
                            .limit(1);

                        if (cartError) {
                            console.error('Error checking cart items:', cartError);
                            alert('Failed to process purchase.');
                            buyButtonClicked = false;
                            return;
                        }

                        if (cartItems && cartItems.length > 0) {
                            // Update existing cart transaction to requested
                            const transacId = cartItems[0].transac_id;
                            const { error: updateError } = await supabaseClient
                                .from('transactions')
                                .update({ status: 'requested' })
                                .eq('transac_id', transacId);

                            if (updateError) {
                                console.error('Error updating transaction status:', updateError);
                                alert('Failed to update transaction status.');
                                buyButtonClicked = false;
                                return;
                            }
                        } else {
                            // Check if a transaction with same buyer, seller, and item exists with status 'requested'
                            const { data: existingTransaction, error: existingError } = await supabaseClient
                                .from('transactions')
                                .select('transac_id')
                                .eq('buyer_id', buyerId)
                                .eq('seller_id', sellerId)
                                .eq('item_uuid', itemId)
                                .eq('status', 'requested')
                                .limit(1);

                            if (existingError && existingError.code !== 'PGRST116') { // PGRST116 = no rows found
                                console.error('Error checking existing requested transaction:', existingError);
                                alert('Failed to process purchase.');
                                buyButtonClicked = false;
                                return;
                            }

                            if (existingTransaction && existingTransaction.length > 0) {
                                // Update existing requested transaction (if any)
                                const transacId = existingTransaction[0].transac_id;
                                const { error: updateError } = await supabaseClient
                                    .from('transactions')
                                    .update({ status: 'requested' })
                                    .eq('transac_id', transacId);

                                if (updateError) {
                                    console.error('Error updating existing requested transaction:', updateError);
                                    alert('Failed to update transaction status.');
                                    buyButtonClicked = false;
                                    return;
                                }
                            } else {
                                // Insert new transaction with status 'requested'
                                const { data: transactionData, error: transactionError } = await supabaseClient
                                    .from('transactions')
                                    .insert([{
                                        buyer_id: buyerId,
                                        buyer_uuid: session.data.session?.user?.id || null,
                                        seller_id: sellerId,
                                        seller_uuid: item.student.user_id || null,
                                        item_uuid: itemId,
                                        status: 'requested'
                                    }]);

                                if (transactionError) {
                                    console.error('Error inserting requested transaction:', transactionError);
                                    alert('Failed to create transaction request.');
                                    buyButtonClicked = false;
                                    return;
                                }
                            }
                        }
                    } catch (err) {
                        console.error('Unexpected error:', err);
                        alert('An unexpected error occurred.');
                        buyButtonClicked = false;
                        return;
                    }

                    // New code: update item status to "reserved" via server API
                    try {
                        // Use full URL with supabaseUrl to avoid relative path issues
                        const apiUrl = `${window.location.origin}/item/${itemId}/buy`;
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${session.data.session?.access_token}`
                            }
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error('Failed to update item status via API:', errorData.message);
                            alert('Failed to update item status.');s
                            buyButtonClicked = false;
                            return;
                        }
                    } catch (err) {
                        console.error('Error updating item status via API:', err);
                        alert('Failed to update item status.');
                        buyButtonClicked = false;
                        return;
                    }

                // Proceed with the rest of the existing buy logic (conversation, messaging, notifications)
                try {
                    // Construct message text based on price type
                    let messageText = '';
                    if (item.item_price_type === 'single') {
                        messageText = `I am interested on buying ${item.item_name} at ‚Ç±${formatPrice(item.item_price)}`;
                    } else if (item.item_price_type === 'range' || item.item_price_type === 'hidden') {
                        messageText = `I am interested on buying ${item.item_name}`;
                    } else {
                        messageText = `I am interested on buying ${item.item_name}`;
                    }

                    // Order user UUIDs to satisfy user_order check constraint
                    const buyerUuid = (await supabaseClient.auth.getSession()).data.session?.user?.id || null;
                    const sellerUuid = item.student.user_id || null;

                    if (!buyerUuid || !sellerUuid) {
                        alert('User authentication information is missing.');
                        buyButtonClicked = false;
                        return;
                    }

                    const user1_uuid = buyerUuid < sellerUuid ? buyerUuid : sellerUuid;
                    const user2_uuid = buyerUuid < sellerUuid ? sellerUuid : buyerUuid;

                    // Check if conversation already exists between buyer and seller
                    // Order integer user IDs to satisfy user_order check constraint
                    const buyerIdInt = parseInt(buyerId, 10);
                    const sellerIdInt = parseInt(sellerId, 10);
                    const user1_id = buyerIdInt < sellerIdInt ? buyerIdInt : sellerIdInt;
                    const user2_id = buyerIdInt < sellerIdInt ? sellerIdInt : buyerIdInt;

                    let { data: existingConversations, error: existingError } = await supabaseClient
                        .from('conversation')
                        .select('conversation_id')
                        .match({ user1_id: user1_id, user2_id: user2_id })
                        .limit(1);

                    if (existingError) {
                        console.error('Error checking existing conversation:', existingError);
                        alert('Failed to initiate conversation.');
                        buyButtonClicked = false;
                        return;
                    }

                    let conversationId;
                    if (existingConversations && existingConversations.length > 0) {
                        conversationId = existingConversations[0].conversation_id;
                    } else {
                        // Create new conversation
                        // Order integer user IDs to satisfy user_order check constraint
                        const buyerIdInt = parseInt(buyerId, 10);
                        const sellerIdInt = parseInt(sellerId, 10);
                        const user1_id = buyerIdInt < sellerIdInt ? buyerIdInt : sellerIdInt;
                        const user2_id = buyerIdInt < sellerIdInt ? sellerIdInt : buyerIdInt;

                        const { data: newConversation, error: createError } = await supabaseClient
                            .from('conversation')
                            .insert([{
                                user1_id: user1_id,
                                user2_id: user2_id,
                                user1_uuid: user1_uuid,
                                user2_uuid: user2_uuid
                            }])
                            .select()
                            .single();

                        if (createError) {
                            console.error('Error creating conversation:', createError);
                            alert('Failed to create conversation.');
                            buyButtonClicked = false;
                            return;
                        }
                        conversationId = newConversation.conversation_id;
                    }

                    // Fetch seller user_id for receiver_uid
                    const { data: sellerUser, error: sellerUserError } = await supabaseClient
                        .from('student')
                        .select('user_id, stud_fname, stud_lname')
                        .eq('stud_id', sellerId)
                        .single();

                    if (sellerUserError || !sellerUser) {
                        console.error('Error fetching seller user_id:', sellerUserError);
                        alert('Failed to send message due to seller info.');
                        buyButtonClicked = false;
                        return;
                    }

                    const receiverUid = sellerUser.user_id;

                    // Fetch buyer user info for notification content
                    const { data: buyerUser, error: buyerUserError } = await supabaseClient
                        .from('student')
                        .select('stud_fname, stud_lname')
                        .eq('stud_id', buyerId)
                        .single();

                    if (buyerUserError || !buyerUser) {
                        console.error('Error fetching buyer user info:', buyerUserError);
                        alert('Failed to send message due to buyer info.');
                        buyButtonClicked = false;
                        return;
                    }

                    // Insert initial message with sender_uid and receiver_uid
                    const { error: messageError } = await supabaseClient
                        .from('message')
                        .insert([{
                            conversation_id: conversationId,
                            sender_id: buyerId,
                            sender_uid: (await supabaseClient.auth.getSession()).data.session?.user?.id || null,
                            receiver_id: sellerId,
                            receiver_uid: receiverUid,
                            mess_content: messageText
                        }]);

                    if (messageError) {
                        console.error('Error sending message:', messageError);
                        alert('Failed to send message.');
                        buyButtonClicked = false;
                        return;
                    }

                    // Insert notification for the seller about the buy request with type 'buy_request'
                    const notificationContentBuyRequest = `${buyerUser.stud_fname} ${buyerUser.stud_lname} wants to buy ${item.item_name}`;
                    const sessionBuyRequest = await supabaseClient.auth.getSession();
                    const senderUuidBuyRequest = sessionBuyRequest.data.session?.user?.id || null;
                    const receiverUuidBuyRequest = receiverUid; // seller's user_id as UUID

                    // Check if existing unread buy_request notification exists
                    const { data: existingBuyRequestNotifications, error: existingBuyRequestError } = await supabaseClient
                        .from('notifications')
                        .select('*')
                        .eq('receiver_id', sellerId)
                        .eq('sender_id', buyerId)
                        .eq('type', 'buy_request')
                        .eq('is_read', false);

                    if (existingBuyRequestError) {
                        console.error('Error checking existing buy_request notifications:', existingBuyRequestError);
                    }

                    if (!existingBuyRequestNotifications || existingBuyRequestNotifications.length === 0) {
                        // Insert new buy_request notification
                        const { data: notificationDataBuyRequest, error: notificationErrorBuyRequest } = await supabaseClient
                            .from('notifications')
                            .insert([{
                                receiver_id: sellerId,
                                sender_id: buyerId,
                                receiver_uuid: receiverUuidBuyRequest,
                                sender_uuid: senderUuidBuyRequest,
                                type: 'buy_request',  // Ensure this is set to 'buy_request' enum type
                                content: notificationContentBuyRequest,
                                is_read: false
                            }]);

                        if (notificationErrorBuyRequest) {
                            console.error('Error inserting buy_request notification:', notificationErrorBuyRequest);
                            // Do not block user flow, just log error
                        } else {
                            console.log('Buy_request notification inserted successfully for sellerId:', sellerId, notificationDataBuyRequest);
                        }
                    } else {
                        // Update existing unread buy_request notification
                        const existingNotification = existingBuyRequestNotifications[0];
                        const updatedContent = `${buyerUser.stud_fname} wants to buy ${item.item_name}`;
                        const { data: updateData, error: updateError } = await supabaseClient
                            .from('notifications')
                            .update({ content: updatedContent, is_read: false, updated_at: new Date().toISOString() })
                            .eq('notification_id', existingNotification.notification_id);

                        if (updateError) {
                            console.error('Error updating buy_request notification:', updateError);
                        } else {
                            console.log('Buy_request notification updated successfully for sellerId:', sellerId, updateData);
                        }
                    }

                    // Redirect to message page with conversation id and seller id
                    window.location.href = `message_page.html?conversation_id=${conversationId}&seller_id=${sellerId}`;
                } catch (err) {
                    console.error('Unexpected error:', err);
                    alert('An unexpected error occurred.');
                    buyButtonClicked = false;
                }
            });
    });
}

// Add to Cart button event listener moved inside fetchItemDetails
const addToCartButton = document.getElementById('add-to-cart-button');
if (addToCartButton) {
    let addToCartClicked = false;
    addToCartButton.addEventListener('click', async () => {
        if (addToCartClicked) return;
        addToCartClicked = true;

        const buyerId = localStorage.getItem('stud_id');
        if (!buyerId) {
            alert('You must be logged in to add items to the cart.');
            addToCartClicked = false;
            return;
        }
        try {
            // Insert a new transaction with status 'cart'
                const { data, error } = await supabaseClient
                    .from('transactions')
                    .insert([{
                        buyer_id: buyerId,
                        buyer_uuid: (await supabaseClient.auth.getSession()).data.session?.user?.id || null,
                        seller_id: item.student.stud_id,
                        seller_uuid: item.student.user_id || null,
                        item_uuid: itemId,
                        status: 'cart'
                    }]);

                if (error) {
                    console.error('Error adding item to cart:', error);
                    showBanner('‚ùå Failed to add item to cart.', 'error');
                    addToCartClicked = false;
                    return;
                }

                // Update button state immediately after successful add
                addToCartButton.textContent = 'Added to Cart';
                addToCartButton.disabled = true;
                showBanner('‚úÖ Item added to cart successfully!', 'success');

                } catch (err) {
                    console.error('Unexpected error adding to cart:', err);
                    showBanner('‚ùå An unexpected error occurred while adding to cart.', 'error');
                    addToCartClicked = false;
                }

    });
}

function showBanner(message, type = "error") {
    const errorMessage = document.getElementById("error-message");

    errorMessage.style.display = "block";
    errorMessage.textContent = message;

    if (type === "success") {
        errorMessage.style.backgroundColor = "#2ecc71"; // green
    } else {
        errorMessage.style.backgroundColor = "#e74c3c"; // red
    }

    setTimeout(() => {
        errorMessage.style.display = "none";
    }, 3000);
}


            const notifyMeButton = document.getElementById('notify-me-button');
            if (notifyMeButton) {
                // Check on page load if user already has a 'cart' transaction for this item
                const buyerId = localStorage.getItem('stud_id');
                if (buyerId) {
                    const { data: existingNotify, error: existingError } = await supabaseClient
                        .from('transactions')
                        .select('transac_id')
                        .eq('buyer_id', buyerId)
                        .eq('item_uuid', itemId)
                        .in('status', ['cart', 'requested']) // Include 'requested' status as well
                        .limit(1);
                    if (!existingError && existingNotify && existingNotify.length > 0) {
                        notifyMeButton.textContent = 'Waiting for Updates';
                        notifyMeButton.disabled = true;
                        // Hide the note when button is in "Waiting for Updates" state
                        const notifyMeNote = document.getElementById('notify-me-note');
                        if (notifyMeNote) {
                            notifyMeNote.style.display = 'none';
                        }
                    }
                }

                let notifyMeClicked = false;
                notifyMeButton.addEventListener('click', async () => {
                    if (notifyMeClicked) return;
                    notifyMeClicked = true;

                    const buyerId = localStorage.getItem('stud_id');
                    if (!buyerId) {
                        alert('You must be logged in to add items to the cart.');
                        notifyMeClicked = false;
                        return;
                    }
                    try {
                        // Insert a new transaction with status 'cart'
                        const { data, error } = await supabaseClient
                            .from('transactions')
                            .insert([{
                                buyer_id: buyerId,
                                buyer_uuid: (await supabaseClient.auth.getSession()).data.session?.user?.id || null,
                                seller_id: item.student.stud_id,
                                seller_uuid: (item.student.user_id) ? item.student.user_id : null,
                                item_uuid: itemId,
                                status: 'cart'
                            }]);
                        if (error) {
                            console.error('Error adding item to cart:', error);
                            alert('Failed to add item to cart.');
                            notifyMeClicked = false;
                            return;
                        }
                        // Update button state immediately after successful add
                        notifyMeButton.textContent = 'Waiting for Updates';
                        notifyMeButton.disabled = true;
                        showBanner('‚úÖ Item added to cart successfully.', 'success');
                    } catch (err) {
                        console.error('Unexpected error adding to cart:', err);
                        alert('An unexpected error occurred while adding to cart.');
                        notifyMeClicked = false;
                    }
                });
            }

}

function redirectToProfile(studId) {
    if (!studId) {
        console.error('stud_id is undefined');
        return;
    }

    // Retrieve the logged-in user's stud_id from localStorage
    const loggedInStudId = localStorage.getItem('stud_id');
    console.log('Logged-in stud_id:', loggedInStudId); // Debugging: Log the logged-in user's stud_id
    console.log('Poster stud_id:', studId); // Debugging: Log the poster's stud_id

    // Convert both studId and loggedInStudId to strings for comparison
    if (String(studId) === String(loggedInStudId)) {
        // Redirect to the user's own profile (editable mode)
        console.log('Redirecting to the user\'s own profile (ViewProfile.html)');
        // Always navigate top window to open full page
        window.top.location.href = 'ViewProfile.html';
    } else {
        // Redirect to the visitor mode profile
        console.log('Redirecting to the visitor profile (View_other.html)');
        // Always navigate top window to open full page
        window.top.location.href = `View_other.html?stud_id=${studId}`;
    }
}
function timeAgo(createdAt) {
            const now = new Date();
            const createdDate = new Date(createdAt);
            const diffInSeconds = Math.floor((now - createdDate) / 1000);

            if (diffInSeconds < 60) {
                return `${diffInSeconds} second${diffInSeconds === 1 ? '' : 's'} ago`;
            }

            const diffInMinutes = Math.floor(diffInSeconds / 60);
            if (diffInMinutes < 60) {
                return `${diffInMinutes} minute${diffInMinutes === 1 ? '' : 's'} ago`;
            }

            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) {
                return `${diffInHours} hour${diffInHours === 1 ? '' : 's'} ago`;
            }

            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) {
                return `${diffInDays} day${diffInDays === 1 ? '' : 's'} ago`;
            }

            const diffInWeeks = Math.floor(diffInDays / 7);
            if (diffInWeeks < 4) {
                return `${diffInWeeks} week${diffInWeeks === 1 ? '' : 's'} ago`;
            }

            const diffInMonths = Math.floor(diffInDays / 30);
            return `${diffInMonths} month${diffInMonths === 1 ? '' : 's'} ago`;
        }

        

let currentZoomIndex = 0;
let zoomImages = [];
let zoomLevel = 1;
const maxZoomLevel = 3;
const zoomStep = 1;

// Create zoom modal elements
const zoomModal = document.createElement('div');
zoomModal.id = 'zoom-modal';
zoomModal.style.position = 'fixed';
zoomModal.style.top = '0';
zoomModal.style.left = '0';
zoomModal.style.width = '100vw';
zoomModal.style.height = '100vh';
zoomModal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
zoomModal.style.display = 'none';
zoomModal.style.justifyContent = 'center';
zoomModal.style.alignItems = 'center';
zoomModal.style.zIndex = '10000';
zoomModal.style.flexDirection = 'column';

const zoomedImage = document.createElement('img');
zoomedImage.id = 'zoomed-image';
zoomedImage.style.maxWidth = '80vw';
zoomedImage.style.maxHeight = '80vh';
zoomedImage.style.borderRadius = '10px';
zoomedImage.style.cursor = 'zoom-in';
zoomedImage.style.transition = 'transform 0.3s ease';

const prevButton = document.createElement('button');
prevButton.innerHTML = '&#8592;'; // Left arrow
prevButton.className = 'modal-arrow left';

const nextButton = document.createElement('button');
nextButton.innerHTML = '&#8594;'; // Right arrow
nextButton.className = 'modal-arrow right';

zoomModal.appendChild(zoomedImage);
zoomModal.appendChild(prevButton); // Append directly to modal
zoomModal.appendChild(nextButton); // Append directly to modal
document.body.appendChild(zoomModal);

function updateZoomedImage() {
    if (!zoomImages.length) return;
    const img = zoomImages[currentZoomIndex];
    zoomedImage.src = img.src;
    zoomedImage.alt = img.alt || 'Zoomed Image';
    zoomLevel = 1;
    zoomedImage.style.transform = 'scale(1)';
    zoomedImage.style.cursor = 'zoom-in';
}

function openZoomModal(index, images) {
    if (images) {
        zoomImages = images;
    } else {
        zoomImages = Array.from(document.querySelectorAll('.carousel-thumbs img'));
    }
    currentZoomIndex = index;
    updateZoomedImage();
    zoomModal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevent background scroll

    // Hide main page back button when zoom modal is open
    const backButton = document.getElementById('backButton');
    if (backButton) {
        backButton.style.display = 'none';
    }

    // Hide prev/next buttons if only one image
    if (zoomImages.length <= 1) {
        prevButton.style.display = 'none';
        nextButton.style.display = 'none';
    } else {
        prevButton.style.display = 'flex';
        nextButton.style.display = 'flex';
    }
}

function closeZoomModal() {
    zoomModal.style.display = 'none';
    document.body.style.overflow = ''; // Restore scroll

    // Hide main page back button when zoom modal is closed (to remove it as requested)
    const backButton = document.getElementById('backButton');
    if (backButton) {
        backButton.style.display = 'none';
    }
}

function zoomToggle(e) {
    e.stopPropagation();
    if (zoomLevel < maxZoomLevel) {
        zoomLevel += zoomStep;
        zoomedImage.style.transform = `scale(${zoomLevel})`;
        zoomedImage.style.cursor = 'zoom-out';
    } else {
        zoomLevel = 1;
        zoomedImage.style.transform = 'scale(1)';
        zoomedImage.style.cursor = 'zoom-in';
    }
}

zoomedImage.addEventListener('click', zoomToggle);
zoomModal.addEventListener('click', (e) => {
    if (e.target === zoomModal) {
        closeZoomModal();
    }
});

prevButton.addEventListener('click', (e) => {
    e.stopPropagation();
    if (zoomImages.length === 0) return;
    currentZoomIndex = (currentZoomIndex - 1 + zoomImages.length) % zoomImages.length;
    updateZoomedImage();
});

nextButton.addEventListener('click', (e) => {
    e.stopPropagation();
    if (zoomImages.length === 0) return;
    currentZoomIndex = (currentZoomIndex + 1) % zoomImages.length;
    updateZoomedImage();
});

function zoomImage(imgElement) {
    // Find thumbnails images
    let images = Array.from(document.querySelectorAll('.carousel-thumbs img'));
    if (images.length === 0) {
        // No thumbnails, likely only one image, use the clicked image itself
        images = [imgElement];
        openZoomModal(0, images);
        return;
    }
    const index = images.indexOf(imgElement);
    if (index === -1) {
        // If clicked image is not in thumbnails, fallback to first image
        openZoomModal(0, images);
    } else {
        openZoomModal(index, images);
    }
}

        // Expose zoomImage to global scope for inline onclick handlers
        window.zoomImage = zoomImage;

        fetchItemDetails();

        // Add real-time subscription to update item details when item status changes
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('item_id');
        if (itemId) {
            supabaseClient
                .channel(`public:item:item_id=eq.${itemId}`)
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'item', filter: `item_id=eq.${itemId}` }, async payload => {
                    console.log('Real-time item update received:', payload);
                    fetchItemDetails();

                    // New logic: if item status changed to "sold", notify users who clicked "Notify Me"
                    const newStatus = payload.new.item_status;
                    const oldStatus = payload.old.item_status;
                    if ((oldStatus === 'reserved' || oldStatus === 'requested') && newStatus === 'sold') {
                        // Removed notification insertion logic here to avoid duplicate or failed insertions
                        // The backend API handles notification insertion on item status update
                        console.log('Item status changed to sold, notifications handled by backend.');
                    }
                })
                .subscribe();

            // New real-time subscription to update "Notify Me" button state when 'cart' transactions change for logged-in user and this item
            const loggedInStudId = localStorage.getItem('stud_id');
            if (loggedInStudId) {
                supabaseClient
                    .channel(`public:transactions:buyer_id=eq.${loggedInStudId}&item_uuid=eq.${itemId}`)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'transactions', filter: `buyer_id=eq.${loggedInStudId},item_uuid=eq.${itemId}` }, async payload => {
                        console.log('Real-time transactions update received:', payload);
                        const notifyMeButton = document.getElementById('notify-me-button');
                        const notifyMeNote = document.getElementById('notify-me-note');
                        if (!notifyMeButton) return;

                        // Check if a 'cart' transaction exists for this user and item
                        const { data: cartItems, error } = await supabaseClient
                            .from('transactions')
                            .select('transac_id')
                            .eq('buyer_id', loggedInStudId)
                            .eq('item_uuid', itemId)
                            .eq('status', 'cart');

                        if (error) {
                            console.error('Error fetching cart items in real-time subscription:', error);
                            return;
                        }

                    if (cartItems && cartItems.length > 0) {
                        // If item status is sold, disable notify me button and update UI accordingly
                        const { data: itemData, error: itemError } = await supabaseClient
                            .from('item')
                            .select('item_status')
                            .eq('item_id', itemId)
                            .single();

                        if (!itemError && itemData && itemData.item_status === 'sold') {
                            notifyMeButton.textContent = 'Item Sold';
                            notifyMeButton.disabled = true;
                            if (notifyMeNote) {
                                notifyMeNote.style.display = 'none';
                            }
                        } else {
                            notifyMeButton.textContent = 'Waiting for Updates';
                            notifyMeButton.disabled = true;
                            if (notifyMeNote) {
                                notifyMeNote.style.display = 'none';
                            }
                        }
                    } else {
                        notifyMeButton.textContent = 'Notify Me';
                        notifyMeButton.disabled = false;
                        if (notifyMeNote) {
                            notifyMeNote.style.display = 'inline';
                        }
                    }
                })
                .subscribe();
            }
        }

        // Removed carousel logic from global scope to fix 'item is not defined' error

        // Removed carousel & modal logic from global scope to fix 'item is not defined' error
    </script>

    <!-- Modal for enlarged image -->
    <div id="image-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
        <span id="close-image-modal" style="position:absolute; top:32px; right:48px; color:#fff; font-size:2.2rem; font-weight:bold; cursor:pointer; z-index:10001;">&times;</span>
        <img id="modal-image" src="" alt="Enlarged Item" style="max-width:80vw; max-height:80vh; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.25); background:#fff; display:block;">
    </div>
</body>
</html>
